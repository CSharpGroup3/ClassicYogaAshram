@using System.Collections
@using System.Globalization
@model Schedule

@{
	ViewBag.Title = "Расписание группы";
	Layout = "_Layout";
}


@if (User.IsInRole("chief") )
{<h2 class="text-center">Расписание группы "@Model.Group.Name"</h2>
 
 <p><strong>Тренер</strong> - @Model.Group.CoachName</p>
 <hr>
 <div id="reloadSchedule">
 	@foreach (var day in @Model.DayOfWeeksString)
 	{
 		<p>@day</p>
 	}
 
 	<p>Начало - @Model.StartTime</p>
 	<p>Окончание - @Model.FinishTime</p>
 	<button data-toggle="modal" data-target="#scheduleCreate" class="btn btn-outline-dark">Изменить расписание</button>
 	<a asp-action="Index" asp-controller="Schedule" asp-route-branchId="@Model.BranchId" class="btn btn-outline-dark">Назад</a>
 
 	<p class="text-hide" id="datesForEdit">@ViewBag.DaysArray</p>
 	<p class="text-hide" id="timeForEditStart">@Model.StartTime</p>
 	<p class="text-hide" id="timeForEditFinish">@Model.FinishTime</p>
 </div>

	<div class="modal fade w-100" id="scheduleCreate" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLongTitle">Изменить расписание</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="editSchedule">
					<input type="hidden" asp-for="GroupId" value="@Model.GroupId" id="groupIdInput">
					<label>Выберите цвет:</label>
					<select name="color" class="form-control mb-2 w-25" id="selectColor">
						<option value="primary" class="bg-primary">Синий</option>
						<option value="success" class="bg-success">Зеленый</option>
						<option value="danger" class="bg-danger">Красный</option>
						<option value="warning" class="bg-warning">Желтый</option>
						<option value="info" class="bg-info">Голубой</option>
						<option value="dark" class="bg-dark text-light">Черный</option>
					</select>
					<label class="mt-2">Время начала занятия:</label>
					<input type="time" id="timeInputStart" name="scheduleTime" class="form-control w-25" onchange="validateSalaryFrom()">
					<label class="mt-2">Время окончания занятия:</label>
					<input type="time" id="timeInputFinish" name="scheduleFinishTime" class="form-control w-25" onchange="validateSalaryTo()">
               		
               		
					<div class="mb-2 mt-2">
						<label class="">Выберите дни:</label>
						<input name="dayOfWeeks" id="dayOfWeekInput" class="form-control w-50 mb-4" readonly>
						<div class="mt-2 mb-2">
							<div id="weekdays"> </div> 
						</div>	
					</div>
					<button class="btn btn-outline-dark mt-4" type="submit" id="submitBtn">Изменить</button>
					<div class="mt-2 text-danger" id="error"></div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
			</div>
		</div>
	</div>
</div>

}

else if ( User.IsInRole("seller") ||User.IsInRole("admin") )
{
	<div id="selectType">
	<h5 class="mb-3">Статус клиента</h5>
	<select id="clientType" class="form-control w-25">
		<option value="3">Выберите тип клиента</option>
		<option value="1">Пробники</option>
		<option value="2">Базовые клиенты</option>
	</select>
	<button class="btn btn-outline-dark mt-2" onclick="openClientForm()">Дальше</button>
	</div>
	<div id="trialBlock" class="trialBlock">
	<div class="row d-flex justify-content-center">
    <div class="col-md-6">
        <h2>Записать на пробный</h2>
	    <form method="post" asp-controller="Clients" asp-action="CreateClients">
		    <input asp-for="BranchId" value="@Model.BranchId" type="hidden">
		    <div>
			    <span asp-validation-for="@Model.ClientsCreateModelView.NameSurname"></span>
			    <label>Ф.И.О</label><br/>
			    <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.NameSurname"/>
		    </div>
		    <div>
			    <span asp-validation-for="@Model.ClientsCreateModelView.PhoneNumber"></span>
			    <label>Номер телефона</label><br/>
			    <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.PhoneNumber"/>
		    </div>
		    <div>
			    <label class="form-control mb-4">Группа:@Model.Group.Name</label>

			    <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.GroupId" value="@Model.GroupId" type="hidden">
		    </div>
		    <input type="hidden" asp-for="@Model.ClientsCreateModelView.ClientType" value="0">		   
		    <div class="form_row">
			    <label>
				    Количество занятий
				    <select asp-for="@Model.ClientsCreateModelView.LessonNumbers" class="form-control mb-4">
					    <option value="1" class="form-control mb-4">1 пробное занятие</option>
					    <option value="3" class="form-control mb-4">3 пробных занятии</option>
				    </select>
			    </label>
		    </div>
		    <div>
			    <div>

				    <label class="form-control mb-4">Дата занятия: @Model.ChosenDate</label><br/>

				    <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.StartDate" type="hidden" value="@Model.ChosenDate">
			    </div>
			    <div>
				    <span asp-validation-for="@Model.ClientsCreateModelView.Comment"></span>
				    <label>Коментарии</label><br/>
				    <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.Comment">
			    </div>

			    <br/>
			    <input class="btn btn-info btn-block my-4" type="submit" value="Добавить"/>
		    </div>
	    </form>
    </div>
</div>
</div>
	<div id="baseClientBlock" class="baseClientBlock">
		<div id="selectSubscription">
			<h5 class="mb-3">Выбор абонемента</h5>
			<select id="subscriptionType" class="form-control w-50">
				@foreach (Membership membership in (IEnumerable) @ViewBag.Memberships)
				{
					<option value="@membership.AttendanceDays @membership.Id">@membership.Name</option>
				}
			</select>
			<button class="btn btn-outline-dark mt-2" onclick="openDetailedForm()">Дальше</button>
		</div>
	</div>
	<div id="bigForm">
		<div id="clientTypeSelection">
		<h5 class="mb-3">Какого клиента необходимо добавить?</h5>
			<button class="btn btn-outline-dark" id="newClient" onclick="openFormToAddNew()">Добавить нового клиента</button>
			<button class="btn btn-outline-dark" id="existingClient" onclick="openToChooseOld()">Добавить существующего клиента</button>
		</div>
		
		<div id="chooseTypeFromList">
			<h5 class="mb-3">Выберите...</h5>
			<select id="chooseTrialOrExisting" class="form-control w-25">
				<option value="0">Выберите</option>
				<option value="1">из пробников</option>
				<option value="2">из старых клиентов</option>
			</select>
			<button class="btn btn-outline-dark mt-2" onclick="openFormExisting()">Выбрать</button>
		</div>
		
		
		<div id="formForNewClient">
		<h5 class="mb-3">Форма для нового клиента</h5>
			<form method="post" asp-controller="Clients" asp-action="NewClientRegister">

            		    <label class="form-control w-50"><strong>Группа:</strong> @Model.Group.Name</label>
            		    <label class="form-control w-50"><strong>Дата первого занятия:</strong> @Model.ChosenDate.ToString("D")</label>
		                <label class="form-control w-75"><strong>Абонемент:</strong> <span id="membershipText"></span></label>
		                                      
		                <input type="hidden" class="form-control mb-4 w-50" value="@Model.GroupId" asp-for="@Model.ClientsCreateModelView.GroupId">
		                <input class="form-control mb-4 w-50" id="membershipId" type="hidden" asp-for="@Model.ClientsCreateModelView.MembershipId">
                       	   
                        <div class="row">
	                        <div class="col-sm-6">                        	
		                        <span asp-validation-for="@Model.ClientsCreateModelView.NameSurname"></span>
		                        <label>Ф.И.О</label><br/>
		                        <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.NameSurname"/>      
	                        </div>                        	                        
	                        <div class="col-sm-6">		                       
			                        <span asp-validation-for="@Model.ClientsCreateModelView.DateOfBirth"></span>
			                        <label>Дата рождения</label><br/>
			                        <input class="form-control mb-4" type="date" asp-for="@Model.ClientsCreateModelView.DateOfBirth"/>		                       
	                        </div>
                        </div>
		                <div class="row">
	                        <div class="col-sm-6">		                           
		                        <span asp-validation-for="@Model.ClientsCreateModelView.PhoneNumber"></span>
		                        <label>Номер телефона</label><br/>
		                        <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.PhoneNumber"/>		                           
	                        </div>
	                            
                        
	                        <div class="col-sm-6">
		                        <span asp-validation-for="@Model.ClientsCreateModelView.Email"></span>
		                        <label>Еmаil:</label><br/>
		                        <input class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.Email"/>
	                        </div>
                        </div>
                        
                        						
                        <div class="row">
                        <div class="col-sm-6">
	                        <label>Место работы и должность:</label><br/>
	                        <textarea class="form-control mb-4" rows="2" asp-for="@Model.ClientsCreateModelView.WorkPlace"></textarea>  
                        </div>

            		    <div class="col-sm-6">
            			    <label>Наличие заболеваний</label><br/>
	                        <textarea class="form-control mb-4" rows="2" asp-for="@Model.ClientsCreateModelView.Sickness"></textarea>   
	                       
            		    </div>
                        </div> 	
                     <div class="row">   
                        <div class="col-sm-6">
                        <span asp-validation-for="@Model.ClientsCreateModelView.Source"></span>
			                <label>Откуда вы о нас узнали?</label><br/>
			                <textarea class="form-control mb-4" rows="2" asp-for="@Model.ClientsCreateModelView.Source"></textarea>           	                        
		                </div>
		    
		                     <div class="col-sm-6">
			                     <span asp-validation-for="@Model.ClientsCreateModelView.Comment"></span>
			                     <label>Коментарий</label><br/>
			                     <textarea class="form-control mb-4" asp-for="@Model.ClientsCreateModelView.Comment" rows="2"></textArea>
		                     </div>
	                 </div>   
            			    <br/>
			                <button class="btn btn-info" type="submit">Добавить</button>
            	    </form>                			
			</div>
				
		<div id="trialClientsList">
			<h5 class="mb-3">Cписок пробников</h5>
		</div>
		<div id="existingClientsList">
			<h5 class="mb-3">Cписок старых клиентов</h5>
		
		</div>

	</div>
	<div id="smallForm">small</div>	
}



@section Scripts{
	
	 @{
            await Html.RenderPartialAsync("_ValidationScriptsPartial");
        }

<script type="text/javascript">
	 	$(".input").focus(function() {
	 		$(this).parent().addClass("focus");
	 	})
	 </script>

	<script >
	
	$("#weekdays").weekLine({
            mousedownSel: false,            
            dayLabels: ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"], 
            onChange: function () {
                   $("#dayOfWeekInput").val(
                           $(this).weekLine('getSelected')
              );
            }
     });
	</script>
    <script>      
       var groupsIds =  $('#groupIdArray').text();            
       $.each(groupsIds.split(' '), function(index, value) {
         $('select > option').filter(function () {
         	return $(this).val() == value
         }).prop('disabled', true)
       });      
    </script>
	<script >
  function validateSalaryTo(){
         var timeFrom = parseInt($("#timeInputStart").val());
    var timeTo = parseInt($("#timeInputFinish").val());     
           if (timeTo < timeFrom) {
           	 $('#error').text('Время начала занятия не может больше времени окончания').show().delay(1500).fadeOut();
              $('#submitBtn').prop('disabled', true);
            } 
          else {
              $('#submitBtn').prop('disabled', false);             
            }
          };
  function validateSalaryFrom(){
           var timeFrom = parseInt($("#timeInputStart").val());
      var timeTo = parseInt($("#timeInputFinish").val());     
             if (timeTo < timeFrom) {
                $('#submitBtn').prop('disabled', true);
                 $('#error').text('Время начала занятия не может больше времени окончания').show().delay(1500).fadeOut();
              } 
            else {
                $('#submitBtn').prop('disabled', false);            
              }
            };
</script>
	<script >
	function validateForm() {
   
        var timeStart = $('#timeInputStart').val();
        var timeFinish = $('#timeInputFinish').val();
        var week = $('#dayOfWeekInput').val();
       
            if (week === "") {
            $('#error').text('Необходимо выбрать день').show().delay(1500).fadeOut();
            return false;
            }
            else if (timeStart === ""){
            $('#error').text('Необходимо выбрать время начала занятия').show().delay(1500).fadeOut();
                return false;
            }
            else if (timeFinish === ""){
            $('#error').text('Необходимо выбрать время окончания занятия').show().delay(1500).fadeOut();
                return false;
            }
            else {
            	
            	$.ajax({
                url : '@Url.Action("Edit", "Schedule")',
                type : 'POST',
                data : {              
                'groupId' : $("#groupIdInput").val(),
                'color': $("#selectColor").val(),
                'scheduleTime': timeStart,
                'scheduleFinishTime': timeFinish, 
                'dayOfWeeks': week,      
             },                                                         
            success: function (data) {
             console.log(data);
                                                
             setTimeout(function(){  
             if(data === "errorTime"){
             $('#error').text('В это время уже есть занятие').show().delay(1500).fadeOut();        
             }             
             else if (data === "success"){
              $("#reloadCalendar").load(" #reloadCalendar");   
              $("#createSchedule").load(" #createSchedule");
              $("#reloadSchedule").load(" #reloadSchedule");
              $("#scheduleCreate").modal("toggle");
              }                                                                                                                
              }, 700)                            
          },
        })
      }          
   }
	</script>
	<script >
	$(function () {   
        $('#editSchedule').on('submit', function (e) {
          e.preventDefault();    
          validateForm();
        });
      });
	</script>
	
	<script >
            $(function(){
            	var timeStart = $('#timeForEditStart').text();
            	$('#timeInputStart').val(timeStart);
            	var timeFinish = $('#timeForEditFinish').text();
                $('#timeInputFinish').val(timeFinish);
                var days =  $('#datesForEdit').text();
                $('#dayOfWeekInput').val(days);
            });
            </script>
	 <script>

</script>
	 <script >	 
	  function openClientForm(){
	  	var option = $('#clientType').val();
	  	
	  	if(option === '1'){
	  		$('.trialBlock').toggle();
	  		$('.baseClientBlock').hide();
	  		$('#selectType').hide();
	  	}
	  	else if(option === '2'){
	  		$('.baseClientBlock').toggle();
	  		$('.trialBlock').hide();
	  		$('#selectType').hide();
	  	}
	  }
</script>
	 <script >
	 function openDetailedForm(){
     	  	var option = $('#subscriptionType').val();
     	  	var optionText = $('#subscriptionType  option:selected').text();
     	  	var theArray = option.split(" ");
     	  	var membershipId = theArray.pop();
     	  	console.log(membershipId);
     	  	if(option.includes('12') || option.includes('8') || option.includes('4')){
     	  		$('#bigForm').toggle();
     	  		$('#smallForm').hide();
     	  		$('.baseClientBlock').hide();
     	  		$('#membershipId').val(membershipId);
     	  		$('#membershipText').text(optionText);
     	  	}
     	  	else if(option.includes('1')){
     	  		$('#smallForm').toggle();
     	  		$('#bigForm').hide();
     	  		$('.baseClientBlock').hide();    	  
     	  	}
     	  }
</script>
	 <script >
	 function openFormToAddNew(){
	 	$('#formForNewClient').toggle();
        $('#clientTypeSelection').hide();
       
	 }
	 function openToChooseOld(){
     	 	$('#chooseTypeFromList').toggle();
            $('#clientTypeSelection').hide();            
     	 }
     	 function openFormExisting() {
     	   var option = $('#chooseTrialOrExisting').val();
              if(option === '1'){
                	$('#trialClientsList').toggle();
                	$('#chooseTypeFromList').hide();
           }
              else if(option === '2'){
                	$('#existingClientsList').toggle();
                	$('#chooseTypeFromList').hide();               	  
           }
     	 }
</script>
}

