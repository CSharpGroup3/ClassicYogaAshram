@model PaymentsIndexModelView
@{
    ViewBag.Title = "Список платежей";
}
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" />
<div class="card text-center">
    <div class="card-header">
        <div  style="margin-left:150px; margin-right:150px">
            <form class="mb-3 border-bottom" asp-action="Index">
                <div class="form-row align-items-center">
                    <div class="col-auto">
                        <input placeholder="Поиск клиента по имени" type="text" class="form-control mb-2" asp-for="FilterByName">
                    </div>
                    <div class="col-auto">
                        <div class="form-group">
                            <select asp-for="ByDate" class="form-control">
                                <option value="@PaymentsDates.AllTime">За все время</option>
                                <option value="@PaymentsDates.LastDay">За последний день</option>
                                <option value="@PaymentsDates.LastWeek">За последнюю неделю</option>
                                <option value="@PaymentsDates.LastMonth">За последний месяц</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary mb-2">Фильтровать</button>
                    </div>
                </div>
            </form>
            <form asp-action="Index" class="mt-3">
                <div class="form-row align-items-center">
                    <div class="col-auto">
                        <div class="form-group">
                            <select asp-for="SortSelect" class="form-control">
                                <option value="">Сортирока по</option>
                                <option value="@SortPaymentsBy.Memberships">По абонементу</option>
                                <option value="@SortPaymentsBy.Price">По цене</option>
                                <option value="@SortPaymentsBy.Group">По группе</option>
                                <option value="@SortPaymentsBy.Comment">По комментарию</option>
                                <option value="@SortPaymentsBy.Sickness">По болезни</option>
                                <option value="@SortPaymentsBy.Debtors">По должникам</option>
                                <option value="@SortPaymentsBy.Debts">По задолженности</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-group">
                            <select asp-for="ByDate" class="form-control">
                                <option value="@PaymentsDates.AllTime">За все время</option>
                                <option value="@PaymentsDates.LastDay">За последний день</option>
                                <option value="@PaymentsDates.LastWeek">За последнюю неделю</option>
                                <option value="@PaymentsDates.LastMonth">За последний месяц</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check mb-2">
                            <input asp-for="SortReverse" class="form-check-input" type="checkbox" id="autoSizingCheck">
                            <label class="form-check-label" for="autoSizingCheck">
                                В обратном порядке
                            </label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary mb-2">Сортировать</button>
                    </div>
                </div>
            </form>
            <div class="form-row align-items-center">
                <div class="col-auto">
                    <div class="form-group col-md-4">
                        <label>Получить сумму</label>
                        <select id="getSumDates" asp-for="ByDate" class="form-control">
                            <option value="@PaymentsDates.AllTime">За все время</option>
                            <option value="@PaymentsDates.LastDay">За последний день</option>
                            <option value="@PaymentsDates.LastWeek">За последнюю неделю</option>
                            <option value="@PaymentsDates.LastMonth">За последний месяц</option>
                        </select>
                    </div>
                </div>
                <div class="col-auto">
                    <button id="getSumBtn" type="button" class="btn btn-primary">Получить</button>
                </div>
            </div>
        <p id="paymentsSum" class="mt-3"></p>
    </div>
        </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Абонемент</th>
                    <th scope="col">Имя клиента, номер телефона</th>
                    <th scope="col">Дата создания</th>
                    <th scope="col">Комментарий</th>
                    <th scope="col">Задолженность</th>
                    <th scope="col">Оплаченная сумма</th>
                    @if (User.IsInRole("chief"))
                    {
                        <th scope="col"></th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var payment in Model.Payments)
                {
                <tr>
                    <th scope="row">@payment.Id</th>
                    <td scope="row">@payment.Membership.Category.Name @payment.Membership.Price тг. @payment.Membership.AttendanceDays посещений</td>
                    <td scope="row">@payment.Client.NameSurname, @payment.Client.PhoneNumber</td>
                    <td scope="row">@payment.CateringDate.ToShortDateString()<br />Последнее обновление - @payment.LastUpdate.ToShortDateString()</td>
                    <td scope="row">@payment.Comment</td>
                    <td scope="row">@payment.Debts</td>
                    <td scope="row">
                        @if (payment.CashSum != 0)
                        {
                            <span>Нал - @payment.CashSum<br /></span>
                        }
                        @if (payment.CardSum != 0)
                        {
                            <span>Безнал - @payment.CardSum</span>
                        }
                    </td>
                    @if (User.IsInRole("chief"))
                    {
                        <td scope="row">
                            <i id="@payment.Id" class="far fa-edit editIcon"></i>
                        </td>
                    }
                </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="card-footer text-muted d-flex justify-content-between">
        @if (Model.CurrentPage != 1)
        {
            <form asp-action="Index" asp-route-pageTo="@(Model.CurrentPage - 1)">
                <input type="hidden" asp-for="FilterByName" value="@Model.FilterByName" />
                <input type="hidden" asp-for="SortReverse" value="@Model.SortReverse" />
                <input type="hidden" asp-for="SortSelect" value="@Model.SortSelect" />
                <input type="hidden" asp-for="FilterByName" value="@Model.FilterByName" />
                <input type="hidden" asp-for="IsNextPage" value="@Model.IsNextPage" />
                <input type="hidden" asp-for="PaymentsLength" value="@Model.PaymentsLength" />
                <button type="submit" class="btn btn-outline-dark">
                    Назад
                </button>
            </form>
        }
        @if (Model.IsNextPage)
        {
            <form asp-action="Index" asp-route-pageTo="@(Model.CurrentPage + 1)">
                <input type="hidden" asp-for="FilterByName" value="@Model.FilterByName" />
                <input type="hidden" asp-for="SortReverse" value="@Model.SortReverse" />
                <input type="hidden" asp-for="SortSelect" value="@Model.SortSelect" />
                <input type="hidden" asp-for="FilterByName" value="@Model.FilterByName" />
                <input type="hidden" asp-for="IsNextPage" value="@Model.IsNextPage" />
                <input type="hidden" asp-for="PaymentsLength" value="@Model.PaymentsLength" />
                <button type="submit" class="btn btn-outline-dark">
                    Вперед
                </button>
            </form>
        }
    </div>
</div>
@section Scripts{
    @if (User.IsInRole("chief"))
    {
        <div id="editModals"></div>
        <script>
        var payments = $('.editIcon');
        for (var i = 0; i < payments.length; i++) {
            let payment = payments[i];
            $(payment).on('click', function () {
                $.get('@Url.Action("GetEditModalAjax", "Payments")/?paymentId=' + $(payment).attr('id'), function (data) {
                    $('#editModals').html(data);
                    $(document.getElementById("paymentEditModal")).modal('show');
                })
            })
        }
        </script>
    }
    <script>
        $('#getSumBtn').on('click', function myfunction() {
            $.get('@Url.Action("GetSumAjax", "Payments")/?date=' + $('#getSumDates').val(), function (data) {
                $('#paymentsSum').html('Общая сумма - ' + data);
            })
        })
    </script>
}
